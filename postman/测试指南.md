# API接口测试指南

本文档提供了使用Postman测试所有API接口的步骤说明。

## 准备工作

1. 安装Postman：前往[Postman官网](https://www.postman.com/downloads/)下载并安装最新版本
2. 导入测试集合：在Postman中导入`test_collection.json`文件
3. 导入环境变量：在Postman中导入`environment.json`文件
4. 确保服务器已启动并运行在`http://localhost:8080`（如果不是，请修改环境变量中的`base_url`）

## 测试流程

### 1. 用户认证测试

首先需要获取授权令牌：

1. 执行"发送验证码"请求
   - 输入一个有效的电子邮箱地址（例如：huangxiaochuan2020@163.com）
   - 在实际应用中，会向该邮箱发送验证码；在测试环境中，通常会有一个固定的测试验证码

2. 执行"登录或注册"请求
   - 使用相同的邮箱和收到的验证码（或测试验证码，如"1234"）
   - 系统会自动保存返回的`token`到环境变量中，后续请求会自动使用此token

> **注意**：API接口需要使用邮箱而不是手机号来进行验证码发送和登录操作。

### 2. 用户管理测试

在获取到授权令牌后，可以测试以下用户管理接口：

1. 获取所有用户
   - 从响应中找到一个用户ID，手动设置到环境变量`user_id`中，供后续测试使用
2. 获取当前用户资料
   - 系统会自动保存当前用户ID到环境变量`self_user_id`中
3. 获取指定用户（使用环境变量中的`user_id`）
4. 普通用户更新自己的信息（使用环境变量中的`self_user_id`）
5. 管理员更新任意用户信息（需要管理员权限，使用环境变量中的`user_id`）
6. 普通用户删除自己的账户（使用环境变量中的`self_user_id`）
   - 注意：此操作会导致当前用户无法继续操作，应作为最后一个测试步骤
7. 管理员删除指定用户（需要管理员权限，使用环境变量中的`user_id`）

> **重要提示**：在测试更新和删除用户功能前，请确保相关的用户ID环境变量已正确设置
>
> **已知问题**：更新用户角色可能不会生效。虽然接口返回成功(200)，但实际角色可能未被更改。测试集合包含专门的请求来验证角色更新是否真正生效。详情请参考《错误排查指南》中的"用户角色更新不生效"章节。

### 3. 博客管理测试

按照以下顺序测试博客管理接口：

1. 获取所有博客
2. 创建新博客（系统会自动保存返回的`blog_id`）
3. 获取指定博客
4. 更新博客
5. 删除博客

### 4. 任务管理测试

按照以下顺序测试任务管理接口：

1. 获取所有任务
2. 创建新任务（系统会自动保存返回的`task_id`）
3. 获取指定任务
4. 更新任务
5. 删除任务

### 5. 问卷管理测试

问卷管理接口分为三个部分：

#### 5.1 问卷基本操作

1. 获取所有问卷
2. 创建新问卷（系统会自动保存返回的`wenjuan_id`）
3. 获取指定问卷
4. 更新问卷
5. 置顶/取消置顶问卷
6. 删除问卷

#### 5.2 问卷分类管理

1. 获取所有分类
2. 创建新分类（系统会自动保存返回的`category_id`）
3. 更新分类
4. 删除分类

#### 5.3 问卷答案管理

1. 提交问卷答案（系统会自动保存返回的`answer_id`）
2. 获取问卷的所有答案
3. 获取答案统计信息
4. 获取指定答案
5. 更新答案
6. 删除答案

## 权限测试

我们的API接口需要测试两种不同权限的用户：

1. **管理员用户**：可以管理所有资源
2. **普通用户**：只能管理自己创建的资源

### 普通用户权限测试

为确保普通用户可以正确管理自己的资源，我们添加了专门的测试请求：

1. **博客管理**
   - 创建博客 → 自动保存到 `self_blog_id` 环境变量
   - 更新自己的博客 → 使用 `self_blog_id` 环境变量
   - 删除自己的博客 → 使用 `self_blog_id` 环境变量

2. **任务管理**
   - 创建任务 → 自动保存到 `self_task_id` 环境变量
   - 更新自己的任务 → 使用 `self_task_id` 环境变量
   - 删除自己的任务 → 使用 `self_task_id` 环境变量

3. **问卷管理**
   - 创建问卷(普通用户) → 自动保存到 `self_wenjuan_id` 环境变量
   - 更新自己的问卷 → 使用 `self_wenjuan_id` 环境变量
   - 删除自己的问卷 → 使用 `self_wenjuan_id` 环境变量

### 普通用户权限测试场景

普通用户应该能够管理自己创建的资源，但不能管理或访问其他用户的资源。我们需要测试以下场景：

#### 0. 用户账户管理权限测试

1. **用户资料查看权限**：
   - 普通用户查看自己的资料 → 成功(200)
   - 普通用户尝试查看他人的详细资料 → 失败(403)或返回有限信息

2. **用户资料更新权限**：
   - 普通用户更新自己的资料 → 成功(200)
   - 普通用户尝试更新他人的资料 → 失败(403)

3. **用户账户删除权限**：
   - 普通用户删除自己的账户 → 成功(200)
   - 普通用户尝试删除他人的账户 → 失败(403)

#### 1. 博客管理权限测试

1. **博客创建权限**：
   - 普通用户创建博客 → 成功(200)，保存ID到`self_blog_id`

2. **博客更新权限**：
   - 普通用户更新自己的博客 → 成功(200)
   - 普通用户尝试更新他人的博客 → 失败(403)

3. **博客删除权限**：
   - 普通用户删除自己的博客 → 成功(200)
   - 普通用户尝试删除他人的博客 → 失败(403)

#### 2. 任务管理权限测试

1. **任务创建权限**：
   - 普通用户创建任务 → 成功(200)，保存ID到`self_task_id`

2. **任务更新权限**：
   - 普通用户更新自己的任务 → 成功(200)
   - 普通用户尝试更新他人的任务 → 失败(403)

3. **任务删除权限**：
   - 普通用户删除自己的任务 → 成功(200)
   - 普通用户尝试删除他人的任务 → 失败(403)

#### 3. 问卷管理权限测试

1. **问卷创建权限**：
   - 普通用户创建问卷 → 成功(200)，保存ID到`self_wenjuan_id`

2. **问卷更新权限**：
   - 普通用户更新自己的问卷 → 成功(200)
   - 普通用户尝试更新他人的问卷 → 失败(403)

3. **问卷删除权限**：
   - 普通用户删除自己的问卷 → 成功(200)
   - 普通用户尝试删除他人的问卷 → 失败(403)

### 测试步骤

1. **准备工作**：
   - 使用普通用户账号登录获取token
   - 使用管理员账号创建一些资源以便测试普通用户的访问限制

2. **执行测试**：
   - 创建：执行普通用户创建资源的请求，保存返回的ID
   - 更新：测试普通用户更新自己和他人资源的权限
   - 删除：测试普通用户删除自己和他人资源的权限
   
3. **验证结果**：
   - 成功场景：状态码应为200
   - 失败场景：状态码应为403(Forbidden)

## 完整API测试计划

为确保所有API路由都得到测试，我们提供了一个完整的路由覆盖检查表：

1. **查看检查表**：打开`API路由完整覆盖检查表.md`文件，查看所有需要测试的路由
2. **按顺序执行**：按照检查表中的顺序执行测试请求
3. **记录结果**：对于每个测试，记录其响应状态和任何异常情况
4. **确认覆盖**：确保所有路由都得到了测试，标记为"✅"

我们的测试集合已经包含了所有API路由的测试请求，包括：
- 所有页面路由（6个）
- 用户认证接口（2个）
- 用户管理接口（7个）