# API测试错误排查指南

本文档提供了在使用Postman测试API接口时可能遇到的常见错误及解决方法。

## HTTP 400 错误 (Bad Request)

### 更新用户 (PUT /user/{id})

- **错误现象**: 收到400状态码 
- **可能原因**: 
  1. 请求体缺少必要字段`email`
  2. 用户ID无效或不存在
  3. JSON格式错误
- **解决方法**:
  1. 确保请求体包含`email`字段
  2. 请求体示例:
  ```json
  {
    "nickname": "更新的用户名",
    "role": "user",
    "email": "huangxiaochuan2020@163.com"
  }
  ```
  3. 确认用户ID是否存在
  4. 检查JSON语法是否正确

### 创建问卷 (POST /user/wenjuans)

- **错误现象**: 收到400状态码
- **可能原因**:
  1. 缺少必要字段（如title、questions等）
  2. 分类ID不存在
- **解决方法**:
  1. 确保请求包含所有必要字段
  2. 先获取有效的分类ID，再创建问卷

## HTTP 401 错误 (Unauthorized)

- **错误现象**: 收到401状态码
- **可能原因**:
  1. 未提供令牌
  2. 令牌已过期
  3. 令牌格式错误
- **解决方法**:
  1. 确保已执行登录请求并保存了token
  2. 检查Authorization头格式是否为`Bearer {token}`
  3. 如果令牌已过期，重新执行登录流程

## HTTP 403 错误 (Forbidden)

- **错误现象**: 收到403状态码
- **可能原因**:
  1. 当前用户没有足够权限
  2. 尝试操作不属于当前用户的资源
- **解决方法**:
  1. 使用管理员账户登录
  2. 确保操作的是自己创建的资源

## HTTP 404 错误 (Not Found)

- **错误现象**: 收到404状态码
- **可能原因**:
  1. URL路径错误
  2. 资源ID不存在
- **解决方法**:
  1. 检查URL路径拼写
  2. 确认资源ID是否存在

## HTTP 500 错误 (Internal Server Error)

- **错误现象**: 收到500状态码
- **可能原因**:
  1. 服务器内部错误
  2. 数据库异常
  3. 邮箱地址重复（更新用户时）
- **解决方法**:
  1. 检查服务器日志
  2. 联系开发团队
  3. 更新用户信息时，确保使用唯一的邮箱地址

### 邮箱地址重复错误

- **错误现象**: 尝试更新用户资料时收到500错误
- **错误日志示例**:
  ```
  2025/04/01 12:33:33 /Users/hxc/Desktop/zonghe1/Stage5-wenda/services/user_server.go:82 Error 1062 (23000): Duplicate entry 'huangxiaochuan2020@163.com' for key 'users.uni_users_email'
  [4.031ms] [rows:0] UPDATE `users` SET `email`='huangxiaochuan2020@163.com',`updated_at`='2025-04-01 12:33:33.214' WHERE id = 106
  [GIN] 2025/04/01 - 12:33:33 | 500 | 5.267584ms | ::1 | PUT "/user/106"
  ```
- **原因**: 数据库中已经存在相同的邮箱地址，邮箱字段有唯一约束
- **解决方法**:
  1. 使用不同的邮箱地址进行测试
  2. 在更新用户信息前，检查该邮箱是否已被其他用户使用
  3. 如有必要，先删除使用相同邮箱的用户账号

## 调试技巧

1. **使用Postman控制台**: 在Postman中打开控制台(View > Show Postman Console)查看详细的请求和响应信息
2. **检查环境变量**: 确保所有需要的环境变量(如auth_token, user_id等)都已正确设置
3. **检查请求头**: 确保Content-Type设置为application/json
4. **查看服务器日志**: 服务器端日志通常会提供更详细的错误信息

## 已知问题与解决方案

### 用户角色更新不生效

- **问题描述**: 
  - 更新用户角色时，虽然接口返回200成功，但实际角色未被更改
  - 日志显示: 
    ```
    [GIN] 2025/04/01 - 12:15:38 | 200 | 4.176833ms | ::1 | PUT "/user/106"
    ```
  - 请求发送: 
    ```json
    {
      "nickname": "更新的用户名",
      "role": "admin",
      "email": "huangxiaochuan2020@163.com"
    }
    ```
  - 但获取用户信息时，角色仍为原值

- **可能原因**:
  1. 后端对角色字段有特殊权限控制
  2. 角色更新功能有意禁用以防止权限滥用
  3. 后端存在实现bug，未正确更新角色字段

- **解决方法**:
  1. 检查后端代码，确认角色更新的具体实现
  2. 与开发团队确认角色更新的权限要求
  3. 如果确实需要更新角色，考虑使用专门的API端点进行角色管理
  4. 临时解决方案：直接在数据库中更新角色值
