<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <title>问卷管理系统</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .container { max-width: 1200px; margin: 0 auto; }
        .nav { margin-bottom: 20px; }
        .nav button { padding: 8px 16px; margin-right: 10px; }
        .form-group { margin-bottom: 15px; }
        .form-group label { display: block; margin-bottom: 5px; }
        .form-group input, .form-group textarea { width: 100%; padding: 8px; }
        table { width: 100%; border-collapse: collapse; margin-top: 20px; }
        th, td { border: 1px solid #ddd; padding: 12px; text-align: left; }
        th { background-color: #f5f5f5; }
        .modal { display: none; position: fixed; top: 50%; left: 50%;
                transform: translate(-50%, -50%); background: white;
                padding: 20px; box-shadow: 0 0 10px rgba(0,0,0,0.1); }
        .modal .modal-content { max-height: 80vh; overflow-y: auto; }
        .category-list { margin-top: 20px; }
        .category-item { padding: 10px; border: 1px solid #ddd; margin-bottom: 5px; }
        .error-message { color: red; font-size: 12px; margin-top: 5px; }
        .question-input { width: 300px; height: 100px; border: 2px solid blue; }
        .question-input.error { border-color: red; }
        .answer-input {
            border: 1px solid #ddd;
            padding: 8px;
            border-radius: 4px;
        }
        .answer-input:focus {
            border-color: #0066cc;
            outline: none;
        }
        #search-results {
            margin-bottom: 20px;
        }
        #answer-form {
            background: #f9f9f9;
            padding: 20px;
            border-radius: 4px;
        }
        /* 添加新的样式 */
        .detail-container {
            padding: 15px;
        }

        .detail-title {
            font-size: 18px;
            color: #333;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 1px solid #eee;
        }

        .detail-item {
            margin-bottom: 15px;
        }

        .detail-label {
            font-weight: bold;
            color: #666;
            margin-bottom: 5px;
        }

        .question-list {
            list-style: none;
            padding: 0;
            margin: 10px 0;
        }

        .question-item {
            background: #f5f5f5;
            padding: 10px;
            margin-bottom: 8px;
            border-radius: 4px;
        }

        .answer-list {
            list-style: none;
            padding: 0;
            margin: 10px 0;
        }

        .answer-item {
            background: #fff;
            padding: 10px;
            margin-bottom: 8px;
            border: 1px solid #e8e8e8;
            border-radius: 4px;
        }

        .answer-item .answer-time {
            font-size: 12px;
            color: #999;
            margin-top: 5px;
        }

        .no-answers {
            color: #999;
            font-style: italic;
        }

        .edit-mode input, .edit-mode textarea {
            width: 100%;
            padding: 8px;
            margin: 5px 0;
            border: 1px solid #ddd;
            border-radius: 4px;
        }

        .edit-buttons {
            margin-top: 15px;
            text-align: right;
        }

        .edit-buttons button {
            margin-left: 10px;
            padding: 5px 15px;
        }

        .edit-question-item {
            position: relative;
            margin-bottom: 15px;
            padding: 10px;
            background: #f9f9f9;
            border-radius: 4px;
        }

        .edit-question-item input {
            width: calc(100% - 100px);
            margin-right: 10px;
        }

        .edit-question-actions {
            position: absolute;
            right: 10px;
            top: 50%;
            transform: translateY(-50%);
        }

        .edit-answer-item {
            position: relative;
            padding: 15px;
            background: #fff;
            border: 1px solid #eee;
            border-radius: 4px;
            margin-bottom: 10px;
        }

        .edit-answer-content {
            margin-bottom: 10px;
        }

        .edit-section {
            margin-bottom: 20px;
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 4px;
        }

        .edit-section-title {
            font-weight: bold;
            margin-bottom: 10px;
            color: #333;
        }

        .category-actions {
            margin-top: 10px;
        }

        .category-actions button {
            margin-right: 8px;
            padding: 4px 8px;
        }

        .edit-category-form {
            margin-top: 10px;
            padding: 10px;
            background: #f5f5f5;
            border-radius: 4px;
            display: none;
        }

        .question-item {
            margin-bottom: 10px;
            display: flex;
            align-items: center;
        }

        .question-item input {
            flex: 1;
            margin-right: 10px;
        }

        .question-item button {
            padding: 4px 8px;
            background: #ff4d4d;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }

        .question-item button:hover {
            background: #ff3333;
        }

        .back-button {
            background-color: #409EFF;
            color: white;
            border: none;
            padding: 8px 20px;
            border-radius: 4px;
            cursor: pointer;
            margin-right: 15px;
        }

        .back-button:hover {
            background-color: #66b1ff;
        }

        .jump-page {
            display: inline-flex;
            align-items: center;
            margin-left: 10px;
        }

        .jump-page input {
            width: 60px;
            padding: 4px 8px;
            margin: 0 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
        }

        .jump-page button {
            padding: 4px 8px;
            background: #409EFF;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }

        .jump-page button:hover {
            background: #66b1ff;
        }

        .pinned-row {
            background-color: #f0f8ff !important;
        }

        .pin-button {
            padding: 4px 8px;
            background: #409EFF;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            margin-right: 5px;
        }

        .pin-button:hover {
            background: #66b1ff;
        }

        .title-cell {
            cursor: pointer;
        }

        .title-cell:hover {
            color: #409EFF;
        }

        .moving-row {
            transition: transform 0.3s ease-in-out;
        }

        .pinned-row {
            background-color: #f0f8ff;
            border-left: 3px solid #409EFF;
        }

        .pin-button {
            background-color: transparent;
            color: #409EFF;
            border: 1px solid #409EFF;
            padding: 4px 8px;
            border-radius: 4px;
            cursor: pointer;
            transition: all 0.3s;
        }

        .pin-button.pinned {
            background-color: #409EFF;
            color: white;
        }

        .moving-row {
            animation: moveToTop 0.5s ease-in-out;
        }

        @keyframes moveToTop {
            from {
                transform: translateY(20px);
                opacity: 0.5;
            }
            to {
                transform: translateY(0);
                opacity: 1;
            }
        }
        .search-pagination {
            margin-top: 20px;
            text-align: center;
        }

        .search-pagination button {
            padding: 5px 15px;
            margin: 0 5px;
            background: #409EFF;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }

        .search-pagination button:disabled {
            background: #ccc;
            cursor: not-allowed;
        }

        .search-pagination span {
            margin: 0 10px;
        }

        #search-title {
            width: 300px;
            padding: 8px;
            margin-right: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
        }

        #search-title:focus {
            border-color: #409EFF;
            outline: none;
        }

        .category-item {
            background: #fff;
            border: 1px solid #e8e8e8;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 15px;
            box-shadow: 0 1px 2px rgba(0,0,0,0.1);
        }

        .category-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }

        .category-count {
            font-size: 14px;
            color: #666;
        }

        .category-description {
            color: #666;
            margin-bottom: 15px;
            font-size: 14px;
        }

        .category-actions {
            display: flex;
            gap: 10px;
        }

        .category-actions button {
            padding: 6px 12px;
            border-radius: 4px;
            border: none;
            cursor: pointer;
        }

        .edit-btn {
            background-color: #409EFF;
            color: white;
        }

        .delete-btn {
            background-color: #F56C6C;
            color: white;
        }

        .edit-category-form {
            margin-top: 15px;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 4px;
        }

        .form-buttons {
            margin-top: 10px;
            text-align: right;
        }

        .form-buttons button {
            margin-left: 10px;
            padding: 6px 12px;
            border-radius: 4px;
            border: none;
            cursor: pointer;
        }
    </style>
</head>
<body>
<div class="container">
    <div class="nav">
        <button class="back-button" onclick="goBack()">返回后台</button>
        <button onclick="showSection('questionnaire-list')">问卷列表</button>
        <button onclick="showSection('create-questionnaire')">创建问卷</button>
        <button onclick="showSection('answer-management')">答案管理</button>
        <button onclick="showSection('category-management')">分类管理</button>
    </div>

    <!-- 问卷列表 -->
    <div id="questionnaire-list" class="section">
        <h2>问卷列表</h2>
        <div class="filter">
            <label>是否置顶：<input type="checkbox" id="filter-pinned" onchange="loadQuestionnaires()"></label>
        </div>
        <table id="questionnaires-table">
            <thead>
            <tr>
                <th>ID</th>
                <th>标题</th>
                <th>状态</th>
                <th>截止日期</th>
                <th>操作</th>
            </tr>
            </thead>
            <tbody id="wenjuanTableBody">
            <!-- 动态填充 -->
            </tbody>
        </table>
        <div class="paginator">
            <button onclick="prevPage()">上一页</button>
            <span id="page-info">第1页/共1页</span>
            <button onclick="nextPage()">下一页</button>
            <div class="jump-page">
                <span>跳转到</span>
                <input type="number" id="jump-page-input" min="1" placeholder="页码">
                <button onclick="jumpToPage()">确定</button>
            </div>
        </div>
    </div>

    <!-- 创建问卷 -->
    <div id="create-questionnaire" class="section" style="display:none">
        <h2>创建问卷</h2>
        <div class="form-group">
            <label>标题</label>
            <input type="text" id="title">
        </div>
        <div class="form-group">
            <label>问题列表</label>
            <div id="create-questions-container">
                <div class="question-item">
                    <input type="text" class="question-input" placeholder="请输入问题">
                </div>
            </div>
            <button type="button" onclick="addQuestionInput()" style="margin-top: 10px;">添加问题</button>
            <div class="error-message" id="content-error"></div>
        </div>
        <div class="form-group">
            <label>状态</label>
            <select id="status">
                <option value="draft">草稿</option>
                <option value="published">已发布</option>
            </select>
        </div>
        <div class="form-group">
            <label>截止日期</label>
            <input type="datetime-local" id="deadline">
        </div>
        <div class="form-group">
            <label>分类</label>
            <select id="category">
                <option value="">无分类</option>
            </select>
        </div>
        <button onclick="createOrUpdateQuestionnaire()">提交</button>
    </div>

    <!-- 答卷管理 -->
    <div id="answer-management" class="section" style="display:none">
        <h2>答卷管理</h2>
        <div class="form-group">
            <label>搜索问卷</label>
            <input type="text" id="search-title" placeholder="输入问卷标题搜索">
            <button onclick="searchWenjuans(1)">搜索</button>
        </div>

        <!-- 问卷搜索结果列表 -->
        <div id="search-results" style="margin-top: 20px;">
            <table id="wenjuan-search-table">
                <thead>
                    <tr>
                        <th>ID</th>
                        <th>标题</th>
                        <th>状态</th>
                        <th>创建时间</th>
                        <th>操作</th>
                    </tr>
                </thead>
                <tbody>
                    <!-- 动态填充 -->
                </tbody>
            </table>
            <!-- 添加搜索结果分页 -->
            <div class="search-pagination" style="margin-top: 20px;">
                <button id="prev-search-page" onclick="searchPrevPage()">上一页</button>
                <span id="search-page-info">第1页/共1页</span>
                <button id="next-search-page" onclick="searchNextPage()">下一页</button>
                <span style="margin-left: 10px;">总记录数: <span id="search-total-count">0</span></span>
            </div>
        </div>

        <!-- 答题区域 -->
        <div id="answer-form" style="display:none; margin-top: 20px;">
            <h3>问卷答题</h3>
            <div id="wenjuan-info"></div>
            <div id="questions-container">
                <!-- 动态填充问题 -->
            </div>
            <button onclick="submitAnswers()" style="margin-top: 20px;">提交答案</button>
        </div>
    </div>

    <!-- 分类管理 -->
    <div id="category-management" class="section" style="display:none">
        <h2>分类管理</h2>
        <div class="form-group">
            <label>分类名称</label>
            <input type="text" id="category-name">
        </div>
        <div class="form-group">
            <label>描述</label>
            <textarea id="category-desc" rows="2"></textarea>
        </div>
        <button onclick="createCategory()">创建分类</button>
        <div class="category-list" id="category-list">
            <!-- 动态填充 -->
        </div>
    </div>

    <!-- 详情模态框 -->
    <div id="modal" class="modal">
        <div class="modal-content">
            <h3>问卷详情</h3>
            <div id="modal-body"></div>
            <button onclick="closeModal()">关闭</button>
        </div>
    </div>
</div>

<script>
const API_URL = 'http://localhost:8080';
let currentPage = 1;
let totalPages = 1;
let categories = [];
let currentWenjuanForAnswer = null; // 存储当前问卷数据
let searchCurrentPage = 1; // Added for search pagination
let searchTotalPages = 1; // Added for search pagination

// 修复 HTML 转义函数，当前实现有语法错误
function escapeTextForHtml(unsafe) {
    if (typeof unsafe !== 'string') return '';
    return unsafe
         .replace(/&/g, "&amp;")
         .replace(/</g, "&lt;")
         .replace(/>/g, "&gt;");
}

// 修复 HTML 属性转义函数
function escapeTextForAttr(unsafe) {
    if (typeof unsafe !== 'string') return '';
    return unsafe.replace(/"/g, "&quot;");
}

// 修改 getAuthToken 函数，增加调试信息并检查多种可能的token键名
function getAuthToken() {
    // 尝试不同可能的token键名
    const token = localStorage.getItem('authToken') || 
                 localStorage.getItem('token') || 
                 localStorage.getItem('userToken') ||
                 sessionStorage.getItem('authToken');
    
    console.log('Token from storage:', token ? '已找到' : '未找到');
    return token;
}

// 增强错误处理的函数
function handleUnauthorized() {
    console.error('用户未登录或登录已过期');
    alert('用户未登录或登录已过期，请重新登录');
    // 可选：记录当前位置并重定向到登录页
    localStorage.setItem('redirectAfterLogin', window.location.href);
    window.location.href = '/'; 
}

// 增强错误处理和初始化逻辑
document.addEventListener('DOMContentLoaded', () => {
    try {
        console.log('页面初始化中...');
        // 检查token并记录状态
        const token = getAuthToken();
        if (!token) {
            console.warn('未找到授权token，请先登录');
            handleUnauthorized();
            return;
        }
        
        // 显示问卷列表前先显示加载状态
        const tbody = document.querySelector('#questionnaires-table tbody');
        if (tbody) {
            tbody.innerHTML = '<tr><td colspan="5" style="text-align: center;">加载中...</td></tr>';
        }
        
        console.log('授权验证通过，准备加载问卷列表');
        showSection('questionnaire-list');
    } catch (error) {
        console.error('初始化失败:', error);
        alert('页面初始化失败: ' + error.message);
    }
});

// 修复 fetchWithAuth 函数中的错误处理逻辑
async function fetchWithAuth(url, options = {}) {
    const token = getAuthToken();
    if (!token) {
        console.error('Authorization token missing');
        handleUnauthorized();
        throw new Error('Unauthorized'); 
    }

    console.log(`Sending request to: ${url}`);
    options.headers = options.headers || {};
    
    // 确保添加正确的授权头
    options.headers = { 
        'Authorization': `Bearer ${token}`,
        ...(options.body ? {'Content-Type': 'application/json'} : {}),
        ...options.headers 
    };

    try {
        const response = await fetch(url, options);
        console.log(`Response status: ${response.status}`);
        
        if (response.status === 401) {
            console.error('服务器返回未授权错误');
            handleUnauthorized();
            throw new Error('Unauthorized');
        } else if (!response.ok) {
            // 修复：先检查内容类型，然后决定如何解析错误
            const contentType = response.headers.get('content-type');
            if (contentType && contentType.includes('application/json')) {
                const errorJson = await response.json();
                throw new Error(errorJson.message || `请求失败 (${response.status})`);
            } else {
                const errorText = await response.text();
                throw new Error(`请求失败 (${response.status}): ${errorText.substring(0, 100)}`);
            }
        }
        
        return response;
    } catch (error) {
        console.error('请求错误:', error);
        if (!error.message.includes('Unauthorized')) {
            // 避免在控制台已经显示错误后再弹窗显示相同错误
            if (!error.message.includes('请求失败')) {
                alert('网络错误: ' + error.message);
            }
        }
        throw error;
    }
}

// 页面切换
function showSection(sectionId) {
    document.querySelectorAll('.section').forEach(sec => sec.style.display = 'none');
    document.getElementById(sectionId).style.display = 'block';
    if(sectionId === 'questionnaire-list') loadQuestionnaires();
    if(sectionId === 'category-management') loadCategories();
    if(sectionId === 'create-questionnaire') loadCategoriesSelect();
}

// 修改加载问卷列表函数
async function loadQuestionnaires(page = 1, pageSize = 10) {
    try {
        const response = await fetchWithAuth(`${API_URL}/user/wenjuans?page=${page}&pageSize=${pageSize}`);
        if (!response.ok) throw new Error('加载失败');

        const data = await response.json();
        const tbody = document.querySelector('#questionnaires-table tbody');
        tbody.innerHTML = '';

        // Check if data.data exists and has the list property
        if (!data || !data.data || !Array.isArray(data.data.list)) {
             console.error('Invalid data structure received:', data);
             tbody.innerHTML = '<tr><td colspan="5">无法加载数据或数据格式错误</td></tr>';
             return;
        }


        const questionnaires = data.data.list;
        const total = data.data.total || questionnaires.length;

        // 按照置顶状态和创建时间排序
        questionnaires.sort((a, b) => {
            if (a.is_pinned !== b.is_pinned) {
                return b.is_pinned ? 1 : -1;
            }
            return new Date(b.created_at) - new Date(a.created_at);
        });

        // 渲染问卷列表
        questionnaires.forEach(q => {
            appendQuestionnaireRow(q, tbody);
        });

        currentPage = page;
        totalPages = Math.ceil(total / pageSize);
        document.getElementById('page-info').textContent = `第${page}页/共${totalPages}页`;
    } catch (error) {
        if (error.message !== 'Unauthorized') { // Avoid double alert
             console.error('加载问卷列表失败:', error);
             alert('加载失败: ' + error.message);
        }
    }
}

// 分页导航
function prevPage() {
    if(currentPage > 1) loadQuestionnaires(currentPage-1);
}
function nextPage() {
    if(currentPage < totalPages) loadQuestionnaires(currentPage+1);
}

// 修改问卷详情显示函数
async function showQuestionnaire(id) {
    try {
        document.getElementById('modal').style.display = 'block';
        const modalBody = document.getElementById('modal-body');
        modalBody.innerHTML = '<div style="text-align: center;">加载中...</div>';

        const response = await fetchWithAuth(`${API_URL}/user/wenjuans/${id}`);
        if (!response.ok) {
            throw new Error('获取问卷失败');
        }

        const data = await response.json();
        // Ensure content is parsed correctly, default to empty array if invalid
        let questions = [];
        try {
            questions = JSON.parse(data.content || '[]');
            if (!Array.isArray(questions)) questions = []; // Ensure it's an array
        } catch (e) {
            console.error("Failed to parse questions content:", data.content, e);
            questions = []; // Default to empty on error
        }


        modalBody.innerHTML = `
            <div class="detail-container" data-wenjuan-id="${id}">
                <div class="detail-title">${escapeTextForHtml(data.title)}</div>

                <div class="detail-item">
                    <div class="detail-label">基本信息</div>
                    <div>状态：${escapeTextForHtml(data.status)}</div>
                    <div>创建时间：${new Date(data.created_at).toLocaleString()}</div>
                    <div>截止日期：${data.deadline ? new Date(data.deadline).toLocaleString() : '无'}</div>
                </div>

                <div class="detail-item">
                    <div class="detail-label">问题列表</div>
                    <ul class="question-list">
                        ${questions.map((q, index) => `
                            <li class="question-item">
                                <span class="question-number">${index + 1}. </span>
                                ${escapeTextForHtml(q)}
                            </li>
                        `).join('')}
                    </ul>
                </div>

                <div class="detail-item">
                    <div class="detail-label">答案列表</div>
                    ${data.answers && data.answers.length > 0 ? `
                        <ul class="answer-list">
                            ${data.answers.map(answer => {
                                // Safely parse answer content
                                let answerContent = [];
                                try {
                                    answerContent = JSON.parse(answer.answer || answer.Answer || '[]');
                                    if (!Array.isArray(answerContent)) answerContent = [];
                                } catch (e) {
                                    console.error("Failed to parse answer content:", answer.answer || answer.Answer, e);
                                    answerContent = [];
                                }
                                return `
                                    <li class="answer-item">
                                        ${questions.map((q, i) => `
                                            <div>
                                                <strong>问${i + 1}：</strong>${escapeTextForHtml(q)}<br>
                                                <strong>答：</strong>${escapeTextForHtml(answerContent[i] || '未答')}
                                            </div>
                                        `).join('<hr style="margin: 8px 0; border: none; border-top: 1px dashed #eee;">')}
                                        <div class="answer-time">
                                            提交时间：${new Date(answer.created_at).toLocaleString()}
                                            ${answer.updated_at && answer.updated_at !== answer.created_at ?
                                                `<br>最后修改：${new Date(answer.updated_at).toLocaleString()}` : ''}
                                        </div>
                                    </li>
                                `;
                            }).join('')}
                        </ul>
                    ` : '<div class="no-answers">暂无答案</div>'}
                </div>
            </div>
        `;
    } catch (error) {
         if (error.message !== 'Unauthorized') {
            console.error('查看详情失败:', error);
            modalBody.innerHTML = `<div class="error-message">加载失败: ${error.message}</div>`;
         } else {
             closeModal(); // Close modal if unauthorized
         }
    }
}

// 关闭模态框
function closeModal() {
    document.getElementById('modal').style.display = 'none';
}

// 添加新的辅助函数，用于格式化问题内容 (Potentially redundant if backend handles format)
function formatQuestions(content) {
    try {
        const parsed = JSON.parse(content);
        if (Array.isArray(parsed)) {
            return content;
        }
    } catch (e) { /* Ignore parsing error */ }

    let cleaned = content.trim().replace(/[\n\r]/g, '');
    if (!cleaned.startsWith('[')) {
        let questions = cleaned.split(/[,，\n\r]+/).map(q => q.trim()).filter(q => q);
        questions = questions.map(q => `"${q.replace(/^["']|["']$/g, '')}"`);
        cleaned = `[${questions.join(',')}]`;
    }
    try {
        JSON.parse(cleaned);
        return cleaned;
    } catch (e) {
        return null;
    }
}

// 添加问题输入框
function addQuestionInput() {
    const container = document.getElementById('create-questions-container');
    const questionDiv = document.createElement('div');
    questionDiv.className = 'question-item';
    questionDiv.innerHTML = `
        <input type="text" class="question-input" placeholder="请输入问题">
        <button type="button" onclick="removeQuestion(this)">删除</button>
    `;
    container.appendChild(questionDiv);
}

// 删除问题
function removeQuestion(button) {
    const questionItem = button.parentElement;
    const container = questionItem.parentElement;
    if (container.children.length > 1) {
        container.removeChild(questionItem);
    } else {
        alert('至少需要保留一个问题');
    }
}

// 修改创建问卷函数
async function createOrUpdateQuestionnaire() {
    const title = document.getElementById('title').value.trim();
    const status = document.getElementById('status').value;
    const deadline = document.getElementById('deadline').value;
    const categoryId = parseInt(document.getElementById('category').value) || null;

    const questions = Array.from(document.querySelectorAll('#create-questions-container .question-input'))
        .map(input => input.value.trim())
        .filter(q => q);

    if (!title) { alert('请输入标题'); return; }
    if (questions.length === 0) { document.getElementById('content-error').textContent = '至少需要输入一个问题'; return; }
     else { document.getElementById('content-error').textContent = ''; } // Clear error

    const requestData = {
        title: title,
        content: JSON.stringify(questions),
        status: status || 'draft',
        category_id: categoryId
    };
    if (deadline) { requestData.deadline = new Date(deadline).toISOString(); }

    try {
        const response = await fetchWithAuth(`${API_URL}/user/wenjuans`, {
            method: 'POST',
            body: JSON.stringify(requestData)
            // Content-Type header is added automatically by fetchWithAuth
        });

        const result = await response.json();
        if (response.ok) {
            alert('创建成功');
            resetForm('create-questionnaire');
            showSection('questionnaire-list');
            await loadQuestionnaires(1);
        } else {
            alert(result.message || '创建失败：' + (result.error || '未知错误'));
        }
    } catch (error) {
        if (error.message !== 'Unauthorized') {
            console.error('创建问卷错误:', error);
            alert('网络错误或服务器异常');
        }
    }
}

// 修改搜索问卷函数
async function searchWenjuans(page = 1) {
    const searchTitle = document.getElementById('search-title').value.trim();
    const tbody = document.querySelector('#wenjuan-search-table tbody');
    tbody.innerHTML = '<tr><td colspan="5" style="text-align: center;">搜索中...</td></tr>';

    try {
        const url = new URL(`${API_URL}/user/wenjuans/search`);
        url.searchParams.append('title', searchTitle);
        url.searchParams.append('page', page.toString());
        url.searchParams.append('pageSize', '10');

        const response = await fetchWithAuth(url.toString());
        const result = await response.json();

        console.log('Search result:', result); // 调试用

        // Check data structure
        if (!result || !result.data || !result.data.list) {
             console.error('Invalid search data structure:', result);
             tbody.innerHTML = '<tr><td colspan="5" style="text-align: center;">搜索结果格式错误</td></tr>';
             updateSearchPagination({ current_page: 1, total_pages: 1, total: 0, has_more: false }); // Reset pagination
             return;
        }

        const data = result.data;
        tbody.innerHTML = '';

        if (data.list.length === 0) {
            tbody.innerHTML = '<tr><td colspan="5" style="text-align: center;">未找到相关问卷</td></tr>';
        } else {
            data.list.forEach(wenjuan => {
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td>${wenjuan.id}</td>
                    <td>${escapeTextForHtml(wenjuan.title)}</td>
                    <td>${wenjuan.status}</td>
                    <td>${new Date(wenjuan.created_at).toLocaleString()}</td>
                    <td>
                        <button onclick="showAnswerForm(${wenjuan.id})"
                                class="btn btn-primary">答题</button>
                    </td>
                `;
                tbody.appendChild(tr);
            });
        }

        updateSearchPagination({
            current_page: data.current_page || 1,
            total_pages: data.total_pages || 1,
            total: data.total || 0,
            has_more: data.has_more || false
        });

    } catch (error) {
        if (error.message !== 'Unauthorized') {
            console.error('搜索失败:', error);
            tbody.innerHTML = `<tr><td colspan="5" style="text-align: center; color: red;">搜索失败: ${error.message}</td></tr>`;
            updateSearchPagination({ current_page: 1, total_pages: 1, total: 0, has_more: false }); // Reset pagination
        }
    }
}

// Search pagination functions
function searchPrevPage() {
    if (searchCurrentPage > 1) {
        searchWenjuans(searchCurrentPage - 1);
    }
}

function searchNextPage() {
    if (searchCurrentPage < searchTotalPages) {
        searchWenjuans(searchCurrentPage + 1);
    }
}

// 更新搜索分页函数
function updateSearchPagination(data) {
    console.log('Updating search pagination with:', data); // 调试用

    const pageInfo = document.getElementById('search-page-info');
    const totalCount = document.getElementById('search-total-count');
    const prevButton = document.getElementById('prev-search-page');
    const nextButton = document.getElementById('next-search-page');

    searchCurrentPage = data.current_page || 1;
    searchTotalPages = data.total_pages || 1;

    if (pageInfo) pageInfo.textContent = `第${searchCurrentPage}页/共${searchTotalPages}页`;
    if (totalCount) totalCount.textContent = data.total || 0;

    if (prevButton) prevButton.disabled = searchCurrentPage <= 1;
    if (nextButton) nextButton.disabled = !data.has_more;
}

// 添加防抖搜索
let searchTimeout = null;
const searchInput = document.getElementById('search-title');
if (searchInput) {
    searchInput.addEventListener('input', () => {
        clearTimeout(searchTimeout);
        searchTimeout = setTimeout(() => {
            searchWenjuans(1); // Start search from page 1 on new input
        }, 500);
    });
}

// 修改 showAnswerForm 函数
async function showAnswerForm(wenjuanId) {
    try {
        const response = await fetchWithAuth(`${API_URL}/user/wenjuans/${wenjuanId}`);
        if (!response.ok) {
            throw new Error('获取问卷失败');
        }

        const wenjuan = await response.json();

        if (wenjuan.status !== 'published') { alert('该问卷未发布，无法答题'); return; }
        if (wenjuan.deadline && new Date(wenjuan.deadline) < new Date()) { alert('该问卷已过期'); return; }

        currentWenjuanForAnswer = wenjuan;
        document.getElementById('answer-form').style.display = 'block';
        document.getElementById('wenjuan-info').innerHTML = `
            <h4>${escapeTextForHtml(wenjuan.title)}</h4>
            <p>截止时间：${wenjuan.deadline ? new Date(wenjuan.deadline).toLocaleString() : '无'}</p>
        `;

        try {
            const questions = JSON.parse(wenjuan.content || '[]');
            const container = document.getElementById('questions-container');
            container.innerHTML = questions.map((q, index) => `
                <div class="form-group">
                    <label>问题 ${index + 1}：${escapeTextForHtml(q)}</label>
                    <textarea
                        id="answer-${index}"
                        class="answer-input"
                        rows="3"
                        placeholder="请输入您的答案"
                    ></textarea>
                </div>
            `).join('');
            document.getElementById('answer-form').scrollIntoView({ behavior: 'smooth' });
        } catch (parseError) {
            console.error('解析问题内容失败:', parseError);
            alert('问卷格式错误');
        }
    } catch (error) {
        if (error.message !== 'Unauthorized') {
            console.error('加载问卷失败:', error);
            alert(error.message || '加载问卷失败');
        }
    }
}

// 修改提交答案函数
async function submitAnswers() {
    if (!currentWenjuanForAnswer) { alert('请先选择问卷'); return; }

    try {
        const questions = JSON.parse(currentWenjuanForAnswer.content || '[]');
        const answers = questions.map((_, index) =>
            document.getElementById(`answer-${index}`).value.trim()
        );

        if (answers.some(a => !a)) { alert('请回答所有问题'); return; }

        const response = await fetchWithAuth(`${API_URL}/user/wenjuans/${currentWenjuanForAnswer.id}/answers`, {
            method: 'POST',
            body: JSON.stringify({
                answer: JSON.stringify(answers)
            })
        });

        if (response.ok) {
            alert('提交成功！');
            document.getElementById('answer-form').style.display = 'none';
            document.getElementById('questions-container').innerHTML = '';
            currentWenjuanForAnswer = null;
        } else {
            const error = await response.json();
            alert(error.message || '提交失败');
        }
    } catch (error) {
        if (error.message !== 'Unauthorized') {
            console.error('提交答案失败:', error);
            alert('提交失败');
        }
    }
}

// 提交答案 (Legacy? Seems unused, submitAnswers is used)
async function submitAnswer() {
    console.warn("submitAnswer function called, but might be deprecated. Use submitAnswers instead.");
    const qid = document.getElementById('answer-qid')?.value; // Use optional chaining
    const answer = document.getElementById('answer-content')?.value;

    if (!qid || !answer) {
        alert("无法获取问卷ID或答案内容");
        return;
    }

    try {
        // Using the correct endpoint /answers instead of /submit
        const response = await fetchWithAuth(`${API_URL}/user/wenjuans/${qid}/answers`, {
            method: 'POST', // Corrected: Added missing 'POST' value
            body: JSON.stringify({ answer: answer }) // Assuming single answer submission? Adjust if needed
        });
        if(response.ok) {
            alert('提交成功');
            const answerContentEl = document.getElementById('answer-content');
            if (answerContentEl) answerContentEl.value = ''; // Clear input only if element exists
        } else {
            const result = await response.json();
            alert(result.message || '提交失败');
        }
    } catch (error) {
         if (error.message !== 'Unauthorized') {
            alert('网络错误');
         }
    }
}

// 下载PDF
async function downloadPDF(id) {
    try {
        // 调用的接口修改为导出问卷结果接口
        const response = await fetchWithAuth(`${API_URL}/user/wenjuans/${id}/answers/export`);
        if (!response.ok) {
             try {
                 const error = await response.json();
                 throw new Error(error.message || `下载失败 (Status: ${response.status})`);
             } catch (e) {
                 throw new Error(`下载失败 (Status: ${response.status})`);
             }
        }
        const blob = await response.blob();
        if (blob.type !== 'application/pdf') {
            console.error("Downloaded content is not PDF:", blob.type);
            const textError = await blob.text();
            console.error("Blob content:", textError);
            throw new Error("下载的文件格式不正确，可能是一个错误页面。");
        }
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `wenjuan_${id}.pdf`;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
    } catch (error) {
        if (error.message !== 'Unauthorized') {
            alert('下载失败: ' + error.message);
        }
    }
}

// 修改加载分类列表函数
async function loadCategories() {
    try {
        console.log('开始加载分类列表...');
        const response = await fetchWithAuth(`${API_URL}/user/wenjuans/categories`);
        const data = await response.json();
        console.log('分类数据:', data);

        if (!response.ok) {
            throw new Error(data.message || '加载分类失败');
        }

        if (!data.data || !Array.isArray(data.data.list)) {
            throw new Error('返回数据格式错误');
        }

        const listDiv = document.getElementById('category-list');
        listDiv.innerHTML = '';

        if (data.data.list.length === 0) {
            listDiv.innerHTML = '<div class="category-item">暂无分类数据</div>';
            return;
        }

        data.data.list.forEach(cat => {
            const item = document.createElement('div');
            item.className = 'category-item';
            item.innerHTML = `
                <div class="category-header">
                    <strong>${escapeTextForHtml(cat.name)}</strong>
                    <span class="category-count">问卷数量: ${cat.wenjuan_count || 0}</span>
                </div>
                <p class="category-description">${escapeTextForHtml(cat.description || '暂无描述')}</p>
                <div class="category-actions">
                    <button class="edit-btn" onclick="showEditCategoryForm(${cat.id}, '${escapeTextForAttr(cat.name)}', '${escapeTextForAttr(cat.description || '')}')">修改</button>
                    <button class="delete-btn" onclick="deleteCategory(${cat.id})">删除</button>
                </div>
                <div id="edit-form-${cat.id}" class="edit-category-form" style="display: none;">
                    <div class="form-group">
                        <label>分类名称:</label>
                        <input type="text" id="edit-name-${cat.id}" value="${escapeTextForAttr(cat.name)}">
                    </div>
                    <div class="form-group">
                        <label>描述:</label>
                        <textarea id="edit-desc-${cat.id}" rows="2">${escapeTextForHtml(cat.description || '')}</textarea>
                    </div>
                    <div class="form-buttons">
                        <button onclick="updateCategory(${cat.id})">保存</button>
                        <button type="button" onclick="cancelEdit(${cat.id})">取消</button>
                    </div>
                </div>
            `;
            listDiv.appendChild(item);
        });
    } catch (error) {
        console.error('加载分类列表失败:', error);
        const listDiv = document.getElementById('category-list');
        listDiv.innerHTML = `<div class="error-message">加载分类失败: ${error.message}</div>`;
    }
}

// 添加显示编辑表单函数
function showEditCategoryForm(id, name, description) {
    // 先隐藏所有编辑表单
    document.querySelectorAll('.edit-category-form').forEach(form => {
        form.style.display = 'none';
    });
    
    const editForm = document.getElementById(`edit-form-${id}`);
    if (editForm) {
        editForm.style.display = 'block';
        document.getElementById(`edit-name-${id}`).value = name;
        document.getElementById(`edit-desc-${id}`).value = description;
    }
}

// 修改创建分类函数，确保只在问卷管理页面执行
async function createCategory() {
    // 检查当前是否在问卷管理页面
    if (!document.getElementById('category-management').style.display === 'block') {
        console.error('不在问卷管理页面');
        return;
    }

    const nameInput = document.getElementById('category-name');
    const descInput = document.getElementById('category-desc');
    const name = nameInput.value.trim();
    const description = descInput.value.trim();

    if (!name) {
        alert('分类名称不能为空');
        return;
    }

    try {
        const response = await fetchWithAuth(`${API_URL}/user/wenjuans/categories`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({ name, description })
        });

        if (!response.ok) {
            const error = await response.json();
            throw new Error(error.message || '创建分类失败');
        }

        alert('创建成功');
        nameInput.value = '';
        descInput.value = '';
        await loadCategories();
        await loadCategoriesSelect();
    } catch (error) {
        console.error('创建分类失败:', error);
        alert(error.message);
    }
}

// 修改 loadCategoriesSelect 函数，增加错误处理
async function loadCategoriesSelect() {
    try {
        console.log('开始加载分类下拉框...');
        const response = await fetchWithAuth(`${API_URL}/user/wenjuans/categories`);
        const data = await response.json();
        console.log('分类下拉框数据:', data);

        if (!response.ok) {
            throw new Error(data.message || '加载分类失败');
        }

        if (!data.data || !Array.isArray(data.data.list)) {
            throw new Error('返回数据格式错误');
        }

        const select = document.getElementById('category');
        select.innerHTML = '<option value="">无分类</option>';
        
        data.data.list.forEach(cat => {
            const opt = document.createElement('option');
            opt.value = cat.id;
            opt.textContent = cat.name;
            select.appendChild(opt);
        });
    } catch (error) {
        console.error('加载分类下拉框失败:', error);
        // 可以选择不显示错误，因为这是次要功能
    }
}

// 删除分类
async function deleteCategory(id) {
    if(confirm('确定删除？删除后关联此分类的问卷将变为无分类。')) { // Added warning
        try {
            const response = await fetchWithAuth(`${API_URL}/user/wenjuans/categories/${id}`, { method: 'DELETE' });
            if (response.ok) {
                alert('删除成功');
                loadCategories(); // Reload list
                loadCategoriesSelect(); // Reload dropdown in create form
            } else {
                 const result = await response.json();
                 alert(result.message || '删除失败');
            }
        } catch (error) {
             if (error.message !== 'Unauthorized') {
                alert('删除失败');
             }
        }
    }
}

// 修改更新分类函数，确保只在问卷管理页面执行
async function updateCategory(id) {
    // 检查当前是否在问卷管理页面
    if (!document.getElementById('category-management').style.display === 'block') {
        console.error('不在问卷管理页面');
        return;
    }

    const nameInput = document.getElementById(`edit-name-${id}`);
    const descInput = document.getElementById(`edit-desc-${id}`);
    
    const name = nameInput.value.trim();
    const description = descInput.value.trim();

    if (!name) {
        alert('分类名称不能为空');
        return;
    }

    try {
        const response = await fetchWithAuth(`${API_URL}/user/wenjuans/categories/${id}`, {
            method: 'PUT',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                name: name,
                description: description
            })
        });

        if (!response.ok) {
            const error = await response.json();
            throw new Error(error.message || '更新失败');
        }

        alert('更新成功');
        document.getElementById(`edit-form-${id}`).style.display = 'none';
        await loadCategories();
        await loadCategoriesSelect();
    } catch (error) {
        console.error('更新分类失败:', error);
        alert(error.message || '更新失败');
    }
}

// 表单重置
function resetForm(sectionId) {
    const form = document.getElementById(sectionId);
    if (form) {
        form.querySelectorAll('input[type="text"], input[type="datetime-local"], textarea, select').forEach(el => {
             if (el.tagName === 'SELECT') {
                 el.selectedIndex = 0; // Reset select to the first option
             } else {
                 el.value = '';
             }
        });
    }

    if (sectionId === 'create-questionnaire') {
        const container = document.getElementById('create-questions-container');
        container.innerHTML = `
            <div class="question-item">
                <input type="text" class="question-input" placeholder="请输入问题">
            </div>
        `;
        document.getElementById('content-error').textContent = '';
    }
}

// 添加返回函数
function goBack() {
    window.location.href = 'http://localhost:8080/admin'; // Ensure this points to the correct admin page URL
}

// 删除问卷
async function deleteQuestionnaire(id) {
    if (!confirm('确定要删除该问卷吗？其所有答案也将被删除。')) { return; }

    try {
        const response = await fetchWithAuth(`${API_URL}/user/wenjuans/${id}`, {
            method: 'DELETE'
        });

        if (response.ok) {
            alert('删除成功');
            loadQuestionnaires(currentPage); // Reload list
        } else {
            const error = await response.json();
            alert(error.message || '删除失败');
        }
    } catch (error) {
        if (error.message !== 'Unauthorized') {
            console.error('删除问卷失败:', error);
            alert('删除失败');
        }
    }
}

// 添加页面跳转函数
function jumpToPage() {
    const input = document.getElementById('jump-page-input');
    const pageNum = parseInt(input.value);

    if (isNaN(pageNum) || pageNum < 1) { alert('请输入有效的页码'); return; }
    if (pageNum > totalPages) { alert(`最大页数为${totalPages}`); return; }

    loadQuestionnaires(pageNum);
    input.value = ''; // Clear input
}

// 修改创建表格行的辅助函数
function appendQuestionnaireRow(q, tbody) {
    console.log('Creating row for questionnaire:', q); // 添加调试日志

    // 格式化截止日期
    let deadlineStr = '无';
    if (q.deadline) {
        try {
            deadlineStr = new Date(q.deadline).toLocaleString();
        } catch (e) {
            console.error('Invalid deadline format:', q.deadline);
        }
    }

    // 格式化状态
    const statusMap = {
        'draft': '草稿',
        'published': '已发布'
    };
    const statusText = statusMap[q.status] || q.status;

    const tr = document.createElement('tr');
    tr.innerHTML = `
        <td>${q.id || ''}</td>
        <td class="title-cell" onclick="showQuestionnaire(${q.id})">${escapeTextForHtml(q.title || '')}</td>
        <td>${escapeTextForHtml(statusText || '')}</td>
        <td>${deadlineStr}</td>
        <td>
            <button onclick="editQuestionnaire(${q.id})">修改</button>
            <button onclick="deleteQuestionnaire(${q.id})">删除</button>
            <button onclick="downloadPDF(${q.id})">下载</button>
        </td>
    `;

    tbody.appendChild(tr);
}

// 添加创建表格行的辅助函数
function appendQuestionnaireRow(q, tbody) {
    const tr = document.createElement('tr');
    tr.setAttribute('data-id', q.id);
    tr.setAttribute('data-created', q.created_at); // Keep original ISO string for sorting
    tr.setAttribute('data-pinned', q.is_pinned ? 'true' : 'false'); // Use string for attribute

    if (q.is_pinned) { tr.className = 'pinned-row'; }

    tr.innerHTML = `
        <td>${q.id}</td>
        <td class="title-cell" onclick="showQuestionnaire(${q.id})">${escapeTextForHtml(q.title)}</td> <!-- Use simpler escape -->
        <td>${escapeTextForHtml(q.status)}</td> <!-- Use simpler escape -->
        <td>${q.deadline ? new Date(q.deadline).toLocaleString() : '无'}</td>
        <td>
            <button class="pin-button ${q.is_pinned ? 'pinned' : ''}"
                    onclick="togglePin(${q.id}, ${!q.is_pinned}, this)">
                ${q.is_pinned ? '❤️ 已置顶' : '🤍 置顶'}
            </button>
            <button onclick="editQuestionnaire(${q.id})">修改</button>
            <button onclick="deleteQuestionnaire(${q.id})">删除</button>
            <button onclick="downloadPDF(${q.id})">下载</button> <!-- Assuming download endpoint exists -->
        </td>
    `;

    // Simplified insertion logic (rely on sort within loadQuestionnaires)
    tbody.appendChild(tr);
}

// 修改置顶/取消置顶功能
async function togglePin(id, shouldPin, button) {
    try {
        const endpoint = shouldPin ? 'pin' : 'unpin';
        const response = await fetchWithAuth(`${API_URL}/user/wenjuans/${id}/${endpoint}`, {
            method: 'POST' // Assuming POST for these actions
            // No body needed, Content-Type added automatically if needed by fetchWithAuth
        });

        if (!response.ok) {
            const error = await response.json();
            throw new Error(error.message || '操作失败');
        }

        // Instead of manually moving rows, just reload the list
        // The list loading function already handles sorting by pinned status
        showNotification(shouldPin ? '已置顶' : '已取消置顶');
        await loadQuestionnaires(currentPage); // Reload the current page

    } catch (error) {
        if (error.message !== 'Unauthorized') {
            console.error('置顶操作失败:', error);
            alert(error.message || '操作失败');
        }
    }
}

// 添加提示消息函数
function showNotification(message, type = 'info') { // Added type parameter
    const notification = document.createElement('div');
    let bgColor = '#409EFF'; // Default info blue
    if (type === 'error') bgColor = '#F56C6C'; // Red for error
    if (type === 'success') bgColor = '#67C23A'; // Green for success

    notification.style.cssText = `
        position: fixed;
        top: 20px;
        right: 20px;
        padding: 10px 20px;
        background: ${bgColor};
        color: white;
        border-radius: 4px;
        z-index: 1000;
        transition: opacity 0.5s ease-out;
        opacity: 0; /* Start hidden */
    `;
    notification.textContent = message;
    document.body.appendChild(notification);

    // Fade in
    setTimeout(() => { notification.style.opacity = '1'; }, 10);

    // Fade out and remove
    setTimeout(() => {
        notification.style.opacity = '0';
        setTimeout(() => notification.remove(), 500); // Remove after fade out
    }, 2500); // Show for 2.5 seconds
}

// 加载问卷列表函数
async function loadWenjuans() {
    try {
        console.log('开始加载问卷列表...');
        
        const token = localStorage.getItem('authToken');
        if (!token) {
            throw new Error('未找到认证令牌');
        }
        
        // 注意这里修改为问卷API路径
        const response = await fetch('/user/wenjuans', {
            method: 'GET',
            headers: {
                'Authorization': `Bearer ${token}`,
                'Accept': 'application/json'
            }
        });
        
        if (!response.ok) {
            const errorText = await response.text();
            throw new Error(`加载问卷列表失败: HTTP ${response.status} - ${errorText}`);
        }

        const data = await response.json();
        console.log('获取到的问卷数据:', data);
        
        const tbody = document.getElementById('wenjuanTableBody');
        tbody.innerHTML = '';

        const wenjuans = data.wenjuans || [];
        
        if (wenjuans.length === 0) {
            tbody.innerHTML = '<tr><td colspan="6" style="text-align: center;">暂无问卷数据</td></tr>';
            return;
        }

        // 渲染问卷列表
        wenjuans.forEach(wenjuan => {
            const tr = document.createElement('tr');
            tr.innerHTML = `
                <td>${wenjuan.id || ''}</td>
                <td>${wenjuan.title || '无标题'}</td>
                <td>${wenjuan.category?.name || '无分类'}</td>
                <td>${wenjuan.is_pinned ? '是' : '否'}</td>
                <td>${formatDate(wenjuan.created_at)}</td>
                <td>
                    <button class="btn btn-view" onclick="viewWenjuan(${wenjuan.id})">查看</button>
                    <button class="btn btn-edit" onclick="openEditModal(${wenjuan.id})">编辑</button>
                    <button class="btn btn-delete" onclick="deleteWenjuan(${wenjuan.id})">删除</button>
                </td>
            `;
            tbody.appendChild(tr);
        });
    } catch (error) {
        console.error('加载问卷列表失败:', error);
        alert('加载问卷列表失败：' + error.message);
    }
}

// 初始化时加载问卷列表
document.addEventListener('DOMContentLoaded', () => {
    // Check for token immediately
    if (!getAuthToken()) {
         handleUnauthorized();
         // Prevent initial load if not authorized
         return;
    }
    showSection('questionnaire-list'); // Show list by default
    // loadCategoriesSelect(); // Load categories for create form immediately
});
</script>
</body>
</html>
